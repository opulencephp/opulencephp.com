#!/usr/bin/env php
<?php
global $argv;
$output = [];
$statusCode = null;

if (count($argv) == 1 || strlen(trim($argv[1])) == 0) {
    echo "No HTML directory specified\n";
    exit(1);
}

$htmlDirectory = $argv[1];
$projectRootDirectory = realpath(__DIR__ . "/..");
$commands = [
    // Go to this project's root directory
    "cd $projectRootDirectory",
    "composer update",
    "composer dump-autoload -o",
    // Generate the necessary files and run tests
    "php apex compile:docs",
    "php apex compile:api",
    "chown -R 48:48 resources",
    "chown -R 48:48 tmp",
    "chmod -R 755 resources",
    "chmod -R 755 tmp",
    "php apex framework:flushcache",
    "vendor/bin/phpunit"
];

exec(implode(" && ", $commands), $output, $statusCode);

foreach ($output as $line) {
    echo $line . "\n";
}

exit($statusCode);